const { cmd } = require("../command");
const axios = require("axios");

cmd(
  {
    pattern: "imagine",
    react: "ğŸ¨",
    desc: "Generate AI Image from text prompt",
    category: "ai",
    filename: __filename,
  },
  async (
    robin,
    mek,
    m,
    { from, quoted, body, isCmd, command, args, q, isGroup, sender, reply }
  ) => {
    try {
      if (!q) return reply("*Please provide a description for the image you want to generate.* ğŸ¨âœ¨\n\n*Example:* .imagine a beautiful sunset over mountains");

      // Send loading message
      await reply("ğŸ¨ *Generating your AI image...* â³\n*This may take a few seconds.*");

      // Clean and prepare the prompt
      const prompt = encodeURIComponent(q.trim());
      
      // Generate image using Pollinations.ai (completely free)
      const imageUrl = `https://image.pollinations.ai/prompt/${prompt}?width=1024&height=1024&seed=${Math.floor(Math.random() * 1000000)}`;
      
      // Download the generated image
      const response = await axios.get(imageUrl, {
        responseType: 'arraybuffer',
        timeout: 60000, // 60 seconds timeout
      });

      if (response.data) {
        // Prepare caption
        const caption = `ğŸ¨ *AI GENERATED IMAGE* ğŸ¨

âœ¨ *Prompt*: ${q}
ğŸ¤– *Generated by*: Pollinations AI
âš¡ *Quality*: 1024x1024

ğŒğšğğ ğ›ğ² *P_I_K_O* â˜¯ï¸`;

        // Send the generated image
        await robin.sendMessage(
          from,
          {
            image: response.data,
            caption: caption,
          },
          { quoted: mek }
        );

        reply("*Your AI image has been generated successfully!* ğŸ¨ğŸ’œ");
      } else {
        throw new Error("Failed to generate image");
      }
    } catch (e) {
      console.error("AI Image Generation Error:", e);
      
      // Handle specific errors
      if (e.code === 'ECONNABORTED') {
        reply("âŒ *Error:* Image generation timed out. Please try again with a simpler prompt.");
      } else if (e.response && e.response.status === 429) {
        reply("âŒ *Error:* Too many requests. Please wait a moment and try again.");
      } else {
        reply(`âŒ *Error generating image:* ${e.message}\n\n*Tip:* Try using a different prompt or try again later.`);
      }
    }
  }
);

// Alternative command pattern for those who prefer 'generate'
cmd(
  {
    pattern: "generate",
    react: "ğŸ–¼ï¸",
    desc: "Generate AI Image from text prompt (alternative command)",
    category: "ai",
    filename: __filename,
  },
  async (
    robin,
    mek,
    m,
    { from, quoted, body, isCmd, command, args, q, isGroup, sender, reply }
  ) => {
    try {
      if (!q) return reply("*Please provide a description for the image you want to generate.* ğŸ–¼ï¸âœ¨\n\n*Example:* .generate a cute cat wearing sunglasses");

      // Send loading message
      await reply("ğŸ–¼ï¸ *Creating your AI artwork...* â³");

      // Clean and prepare the prompt
      const prompt = encodeURIComponent(q.trim());
      
      // Different style variations for the generate command
      const styles = [
        "?style=photorealistic",
        "?style=digital-art", 
        "?style=anime",
        "?style=oil-painting",
        "?style=watercolor"
      ];
      
      const randomStyle = styles[Math.floor(Math.random() * styles.length)];
      
      // Generate image with random style
      const imageUrl = `https://image.pollinations.ai/prompt/${prompt}${randomStyle}&width=1024&height=1024&seed=${Math.floor(Math.random() * 1000000)}`;
      
      // Download the generated image
      const response = await axios.get(imageUrl, {
        responseType: 'arraybuffer',
        timeout: 60000,
      });

      if (response.data) {
        // Prepare caption
        const caption = `ğŸ–¼ï¸ *AI ARTWORK GENERATED* ğŸ–¼ï¸

ğŸ¯ *Prompt*: ${q}
ğŸ¨ *Style*: ${randomStyle.replace('?style=', '').replace('-', ' ')}
ğŸ¤– *AI Engine*: Pollinations
ğŸ“ *Resolution*: 1024x1024

ğŒğšğğ ğ›ğ² *P_I_K_O* â˜¯ï¸`;

        // Send the generated image
        await robin.sendMessage(
          from,
          {
            image: response.data,
            caption: caption,
          },
          { quoted: mek }
        );

        reply("*Your AI artwork is ready!* ğŸ–¼ï¸ğŸ’™");
      } else {
        throw new Error("Failed to generate artwork");
      }
    } catch (e) {
      console.error("AI Art Generation Error:", e);
      reply(`âŒ *Error creating artwork:* ${e.message}\n\n*Please try again with a different prompt.*`);
    }
  }
);
